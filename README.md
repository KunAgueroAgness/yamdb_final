![Workflow stat](https://github.com/KunAgueroAgness/yamdb_final/actions/workflows/yamdb_workflow.yml/badge.svg)

## REST API YamDB - база отзывов о фильмах, музыке и книгах

### _Технологии_

```
- asgiref==3.2.10
- Django==2.2.16
- django-filter==2.4.0
- djangorestframework==3.12.4
- djangorestframework-simplejwt==4.8.0
- gunicorn==20.0.4
- psycopg2-binary==2.8.6
- PyJWT==2.1.0
- pytz==2020.1
- sqlparse==0.3.1
```

### _Описание_

Выполнена настройка для приложения Continuous Integration и Continuous Deployment, а это значит, что реализовано:
- автоматический запуск тестов,
- обновление образов на Docker Hub,
- автоматический деплой на боевой сервер при пуше в главную ветку main.

### _Результат_

Проект YaMDb собирает отзывы (Review) пользователей на произведения (Titles). Произведения делятся на категории: «Книги», «Фильмы», «Музыка». Список категорий (Category) может быть расширен администратором. Сами произведения в YaMDb не хранятся, здесь нельзя посмотреть фильм или послушать музыку. В каждой категории есть произведения: книги, фильмы или музыка. Произведению может быть присвоен жанр (Genre) из списка предустановленных. Новые жанры может создавать только администратор. Пользователи оставляют к произведениям текстовые отзывы (Review) и ставят произведению оценку в диапазоне от одного до десяти; из пользовательских оценок формируется усреднённая оценка произведения — рейтинг. На одно произведение пользователь может оставить только один отзыв.

### _Ресурсы API YaMDb_

- Ресурс ***auth***: аутентификация.
- Ресурс ***users***: пользователи.
- Ресурс ***titles***: произведения, к которым пишут отзывы (определённый фильм, книга или песенка).
- Ресурс ***categories***: категории (типы) произведений («Фильмы», «Книги», «Музыка»).
- Ресурс ***genres***: жанры произведений. Одно произведение может быть привязано к нескольким жанрам.
- Ресурс ***reviews***: отзывы на произведения. Отзыв привязан к определённому произведению.
- Ресурс ***comments***: комментарии к отзывам. Комментарий привязан к определённому отзыву.

Каждый ресурс описан в документации: указаны эндпоинты (адреса, по которым можно сделать запрос), разрешённые типы запросов, права доступа и дополнительные параметры, если это необходимо.
***Путь к документации (redoc) в блоке описания запуска проекта***.

### _Самостоятельная регистрация пользователя_

1. Пользователь отправляет POST-запрос с параметрами "email" и "username" на эндпоинт:
```
/api/v1/auth/signup/
```
2. Сервис YaMDB отправляет письмо с кодом подтверждения (confirmation_code) на указанный адрес email.
3. Пользователь отправляет POST-запрос с параметрами "username" и "confirmation_code" на эндпоинт:
```
/api/v1/auth/token/
```
4. В ответе на запрос ему приходит token (JWT-токен).

В результате пользователь получает токен и может работать с API проекта, отправляя этот токен с каждым запросом. После регистрации и получения токена пользователь может отправить PATCH-запрос на эндпоинт:
```
/api/v1/users/me/
```
и заполнить поля в своём профайле (описание полей — в документации).

### _Создание пользователя администратором_

Пользователя может создать администратор — через админ-зону сайта или через POST-запрос на специальный эндпоинт:
```
/api/v1/users/
```
Описание полей запроса для этого случая — в документации. После этого пользователь должен самостоятельно отправить свой email и username на эндпоинт (письмо с кодом подтверждения пользователю не отправляется):
```
/api/v1/auth/signup/
```
В ответ должно прийти письмо с кодом подтверждения.
Далее пользователь отправляет POST-запрос с параметрами "username" и "confirmation_code" на эндпоинт:
```
/api/v1/auth/token/
```
В ответе на запрос приходит token (JWT-токен), как и при самостоятельной регистрации.

### _Как запустить проект:_

Клонировать репозиторий:

```
git@github.com:KunAgueroAgness/infra_sp2.git
```

Перейти в папку infra и запустить docker-compose.yaml
(при установленном и запущенном Docker)
```
cd infra_sp2/infra
docker-compose up
```

Для пересборки контейнеров выполнять команду:
(находясь в папке infra, при запущенном Docker)
```
docker-compose up -d --build
```

В контейнере web выполнить миграции:

```
docker-compose exec web python manage.py migrate
```

Создать суперпользователя:

```
docker-compose exec web python manage.py createsuperuser
```

Собрать статику:

```
docker-compose exec web python manage.py collectstatic --no-input
```

Проверьте работоспособность приложения, для этого перейдите на страницу:

```
 http://158.160.20.37/admin/
```
## _Подготовка сервера_
Работа происходит с виртуальной машиной ( в данном случае в Яндекс.Облаке). Чтобы всё прошло успешно, сервер нужно подготовить к работе.

1 Войдите на свой удаленный сервер в облаке.

2 Остановите службу nginx:

```
 sudo systemctl stop nginx
```
3 Установите docker:
```
sudo apt install docker.io
```
4 Установите docker-compose, с этим вам поможет [официальная документация](https://docs.docker.com/compose/install/)

5 Скопируйте файлы _docker-compose.yaml_ и _nginx/default.conf_ из вашего проекта на сервер в _home/<ваш_username>/docker-compose.yaml_ и _home/<ваш_username>/nginx/default.conf_ соответственно.

6 Добавьте в Secrets GitHub Actions переменные окружения для работы базы данных; отредактируйте инструкции workflow для задачи _deploy:_

7 Подключиться к серверу и создать суперпользователя в контейнере web:

```
ssh <пользователь>@<ip-адрес сервера>
```

```
sudo docker-compose exec web python manage.py createsuperuser
```


***Документация*** (запросы для работа с API):

```
 http://158.160.20.37/redoc/
```


Автор проекта:

```
Эльдар Сабирович
```
